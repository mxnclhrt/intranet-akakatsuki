<!DOCTYPE html>
<html lang="fr">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Le Calendrier de l'Akakatsuki</title>

	<script>
		const SESSION_KEY = "intranet_auth_ok_v2";
		if(!sessionStorage.getItem(SESSION_KEY)){
			window.location.href = "login.html";
		}
	</script>

	<link rel="icon" type="image/png" href="../img/Akatsuki-Logo.svg"/>
	<link rel="stylesheet" href="../css/style.css">
	<link rel="stylesheet" href="../css/style-calendrier.css">
</head>
<body>

<a href="secret.html" class="clickable-cloud" aria-label="Lien cach√© vers la base secr√®te"></a>

<header>
	<div class="header-content">
		<div class="header-text">
			<h1>Le Calendrier de l'Akakatsuki</h1>
			<p>Les Douze Lunes du Nuage Rouge</p>
		</div>
	</div>
</header>

<main>
	<div class="group-buttons">
		<button class="group-btn selected" data-groupe="INFOG1">G1</button>
		<button class="group-btn"          data-groupe="INFOG2">G2</button>
	</div>

	<div class="controls">
		<button id="prevWeek">‚óÄ Semaine pr√©c√©dente</button>
		<span class="week-label" id="weekLabel"></span>
		<button id="nextWeek">Semaine suivante ‚ñ∂</button>
	</div>
	<div class="calendar-grid" id="calendar"></div>
</main>

<script>
	const buttons = document.querySelectorAll(".group-btn");

	buttons.forEach(btn => {
		btn.addEventListener("click", () => {
			// Supprime la s√©lection sur tous
			buttons.forEach(b => b.classList.remove("selected"));
			// Ajoute la s√©lection au bouton cliqu√©
			btn.classList.add("selected");
			console.log("Groupe choisi :", btn.dataset.groupe);
			// Ici tu peux filtrer ton calendrier selon btn.dataset.groupe
		});
	});
</script>


<div class="home-btn-container">
	<button onclick="window.location.href='../../index.html';">
		Accueil de l'Intranet
	</button>
</div>

<footer>
	<p>&copy; 2025 Akatsuki Intranet</p>
</footer>

<script>
	async function loadICS() {
		const res = await fetch('../emploi-du-temps/emploi.ics');
		const icsText = await res.text();
		const events = parseICS(icsText);
		return events.sort((a, b) => a.start - b.start);
	}

	function parseICS(text) {
		const lines = text.split('\n');
		const events = [];
		let current = null;

		for (let line of lines) {
			line = line.trim();
			if (line === 'BEGIN:VEVENT') {
				current = {};
			} else if (line === 'END:VEVENT' && current) {
				if (current.start && current.summary && !current.uid?.includes('COURSANNULE') && !current.uid?.includes('Ferie')) {
					events.push(current);
				}
				current = null;
			} else if (current) {
				if (line.startsWith('DTSTART')) current.start = parseICSDate(line);
				if (line.startsWith('DTEND')) current.end = parseICSDate(line);
				if (line.startsWith('SUMMARY')) current.summary = line.split(':')[1];
				if (line.startsWith('LOCATION')) current.location = line.split(':')[1];
				if (line.startsWith('UID')) current.uid = line.split(':')[1];
			}
		}
		return events;
	}

	// ‚úÖ Correction ici : d√©tection du fuseau et conversion UTC ‚Üí local
	function parseICSDate(line) {
		const [meta, value] = line.split(':');
		if (!value) return null;

		// Format UTC (finit par Z)
		if (value.endsWith('Z')) {
			const year = +value.slice(0, 4);
			const month = +value.slice(4, 6) - 1;
			const day = +value.slice(6, 8);
			const hour = +value.slice(9, 11);
			const minute = +value.slice(11, 13);
			// On cr√©e la date en UTC, JS la convertira en locale automatiquement
			return new Date(Date.UTC(year, month, day, hour, minute));
		}

		// Format avec fuseau horaire explicite (Europe/Paris)
		if (meta.includes('TZID=Europe/Paris')) {
			const year = +value.slice(0, 4);
			const month = +value.slice(4, 6) - 1;
			const day = +value.slice(6, 8);
			const hour = +value.slice(9, 11);
			const minute = +value.slice(11, 13);
			// Pas besoin de conversion, c‚Äôest d√©j√† local
			return new Date(year, month, day, hour, minute);
		}

		// Sinon, on suppose que c‚Äôest une heure locale
		const year = +value.slice(0, 4);
		const month = +value.slice(4, 6) - 1;
		const day = +value.slice(6, 8);
		const hour = +value.slice(9, 11);
		const minute = +value.slice(11, 13);
		return new Date(year, month, day, hour, minute);
	}

	function getWeekNumber(date) {
		const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
		const dayNum = d.getUTCDay() || 7;
		d.setUTCDate(d.getUTCDate() + 4 - dayNum);
		const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
		return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
	}

	function getWeekDays(weekNumber, year) {
		const simple = new Date(year, 0, 1 + (weekNumber - 1) * 7);
		const dow = simple.getDay();
		const ISOweekStart = simple;
		if (dow <= 4) {
			ISOweekStart.setDate(simple.getDate() - simple.getDay() + 1);
		} else {
			ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay());
		}
		
		const days = [];
		for (let i = 0; i < 6; i++) {
			const day = new Date(ISOweekStart);
			day.setDate(ISOweekStart.getDate() + i);
			days.push(day);
		}
		return days;
	}

	function displayWeek(events, week) {
		const container = document.getElementById('calendar');
		container.innerHTML = '';
		
		const year = new Date().getFullYear();
		const weekDays = getWeekDays(week, year);
		
		document.getElementById('weekLabel').textContent = `Semaine ${week}`;

		const dayNames = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];

		weekDays.forEach((date, index) => {
			const dayColumn = document.createElement('div');
			dayColumn.className = 'day-column';

			const dayHeader = document.createElement('div');
			dayHeader.className = 'day-header';
			dayHeader.innerHTML = `
				<div class="day-name">${dayNames[index]}</div>
				<div class="day-date">${date.getDate()}/${date.getMonth() + 1}</div>
			`;
			dayColumn.appendChild(dayHeader);

			const eventsContainer = document.createElement('div');
			eventsContainer.className = 'events-container';

			const dayEvents = events.filter(e => e.start.toDateString() === date.toDateString())
									.sort((a, b) => a.start - b.start);

			if (dayEvents.length === 0) {
				const noEvents = document.createElement('div');
				noEvents.className = 'no-events';
				noEvents.textContent = 'Le sang a assez coul√©';
				eventsContainer.appendChild(noEvents);
			} else {
				dayEvents.forEach(ev => {
					const eventCard = document.createElement('div');
					eventCard.className = 'event-card';
					eventCard.innerHTML = `
						<div class="event-time">
							${ev.start.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})} 
							- ${ev.end.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})}
						</div>
						<div class="event-summary">${ev.summary}</div>
						${ev.location ? `<div class="event-location">üìç ${ev.location}</div>` : ''}
					`;
					eventsContainer.appendChild(eventCard);
				});
			}

			dayColumn.appendChild(eventsContainer);
			container.appendChild(dayColumn);
		});
	}

	let allEvents = [];
	let currentWeek = null;

	loadICS().then(events => {
		allEvents = events;
		if (events.length > 0) {
			currentWeek = getWeekNumber(new Date());
			displayWeek(allEvents, currentWeek);
		}
	});

	document.getElementById('prevWeek').addEventListener('click', () => {
		currentWeek--;
		displayWeek(allEvents, currentWeek);
	});

	document.getElementById('nextWeek').addEventListener('click', () => {
		currentWeek++;
		displayWeek(allEvents, currentWeek);
	});
</script>

</body>
</html>